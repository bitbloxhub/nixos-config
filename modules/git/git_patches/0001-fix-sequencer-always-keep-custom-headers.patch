From b73fb88e0b3386e9d62b9d5adc2824d99dbd74cb Mon Sep 17 00:00:00 2001
From: bitbloxhub <45184892+bitbloxhub@users.noreply.github.com>
Date: Mon, 17 Nov 2025 00:13:56 +0000
Subject: [PATCH] fix(sequencer): always keep custom headers

---
 builtin/commit.c | 22 +++++++++++++++++
 commit.c         |  8 +++----
 commit.h         |  6 ++++-
 sequencer.c      | 61 +++++++++++++++++++++++++++++++++++++++++-------
 4 files changed, 82 insertions(+), 15 deletions(-)

diff --git a/builtin/commit.c b/builtin/commit.c
index 0243f17d53..abcf9e80db 100644
--- a/builtin/commit.c
+++ b/builtin/commit.c
@@ -114,6 +114,8 @@ static enum {
 static const char *force_author;
 static char *logfile;
 static char *template_file;
+static char *extra_commit_header_file;
+
 /*
  * The _message variables are commit names from which to take
  * the commit message and/or authorship.
@@ -1773,6 +1775,7 @@ int cmd_commit(int argc,
 		},
 		OPT_PATHSPEC_FROM_FILE(&pathspec_from_file),
 		OPT_PATHSPEC_FILE_NUL(&pathspec_file_nul),
+		OPT_FILENAME(0, "extra-commit-header-file", &extra_commit_header_file, N_("take extra headers from this file")),
 		/* end commit contents options */
 
 		OPT_HIDDEN_BOOL(0, "allow-empty", &allow_empty,
@@ -1930,6 +1933,25 @@ int cmd_commit(int argc,
 		append_merge_tag_headers(parents, &tail);
 	}
 
+	if (extra_commit_header_file) {
+		FILE *extra_header_file = xfopen(extra_commit_header_file, "r");
+		struct strbuf extra_commit_headers = STRBUF_INIT;
+		strbuf_read(&extra_commit_headers, fileno(extra_header_file), 0);
+		struct commit_extra_header *extra_commit_headers_from_file = read_commit_extra_header_lines(extra_commit_headers.buf, extra_commit_headers.len, NULL);
+		struct commit_extra_header *extra_cursor = extra;
+		if (extra_cursor) {
+			while (true) {
+				if (extra_cursor->next == NULL) {
+					break;
+				}
+				extra_cursor = extra_cursor->next;
+			}
+			extra_cursor->next = extra_commit_headers_from_file;
+		} else {
+			extra = extra_commit_headers_from_file;
+		}
+	}
+
 	if (commit_tree_extended(sb.buf, sb.len, &the_repository->index->cache_tree->oid,
 				 parents, &oid, author_ident.buf, NULL,
 				 sign_commit, extra)) {
diff --git a/commit.c b/commit.c
index 16d91b2bfc..66961f10a9 100644
--- a/commit.c
+++ b/commit.c
@@ -33,8 +33,6 @@
 #include "object-file-convert.h"
 #include "prio-queue.h"
 
-static struct commit_extra_header *read_commit_extra_header_lines(const char *buf, size_t len, const char **);
-
 int save_commit_buffer = 1;
 int no_graft_file_deprecated_advice;
 
@@ -1411,8 +1409,8 @@ static int convert_commit_extra_headers(const struct commit_extra_header *orig,
 	return 0;
 }
 
-static void add_extra_header(struct strbuf *buffer,
-			     const struct commit_extra_header *extra)
+void add_extra_header(struct strbuf *buffer,
+		      const struct commit_extra_header *extra)
 {
 	strbuf_addstr(buffer, extra->key);
 	if (extra->len)
@@ -1471,7 +1469,7 @@ static int excluded_header_field(const char *field, size_t len, const char **exc
 	return 0;
 }
 
-static struct commit_extra_header *read_commit_extra_header_lines(
+struct commit_extra_header *read_commit_extra_header_lines(
 	const char *buffer, size_t size,
 	const char **exclude)
 {
diff --git a/commit.h b/commit.h
index 1d6e0c7518..686b6da0cb 100644
--- a/commit.h
+++ b/commit.h
@@ -281,7 +281,11 @@ int commit_tree_extended(const char *msg, size_t msg_len,
 			 const char *author, const char *committer,
 			 const char *sign_commit, const struct commit_extra_header *);
 
-struct commit_extra_header *read_commit_extra_headers(struct commit *, const char **);
+void add_extra_header(struct strbuf *buffer, const struct commit_extra_header *extra);
+
+struct commit_extra_header *read_commit_extra_header_lines(const char *buf, size_t len, const char **exclude);
+
+struct commit_extra_header *read_commit_extra_headers(struct commit *, const char **exclude);
 
 void free_commit_extra_headers(struct commit_extra_header *extra);
 
diff --git a/sequencer.c b/sequencer.c
index 5476d39ba9..8f0ff29a5b 100644
--- a/sequencer.c
+++ b/sequencer.c
@@ -1120,9 +1120,16 @@ static int run_command_silent_on_success(struct child_process *cmd)
 static int run_git_commit(const char *defmsg,
 			  const char *reflog_action,
 			  struct replay_opts *opts,
+			  struct commit_extra_header *extra,
 			  unsigned int flags)
 {
+	struct strbuf header_strbuf = STRBUF_INIT;
 	struct child_process cmd = CHILD_PROCESS_INIT;
+	struct strbuf extra_header_file_path = STRBUF_INIT;
+	int extra_header_file_path_fd;
+	strbuf_addstr(&extra_header_file_path, "/tmp/extra_header_file.XXXXXX");
+	extra_header_file_path_fd = xmkstemp(extra_header_file_path.buf);
+	close(extra_header_file_path_fd);
 
 	cmd.git_cmd = 1;
 
@@ -1175,6 +1182,20 @@ static int run_git_commit(const char *defmsg,
 	if (!(flags & EDIT_MSG))
 		strvec_push(&cmd.args, "--allow-empty-message");
 
+	strvec_pushl(&cmd.args, "--extra-commit-header-file", extra_header_file_path.buf, NULL);
+
+	while (extra) {
+		add_extra_header(&header_strbuf, extra);
+		extra = extra->next;
+	}
+
+	FILE *extra_header_file = xfopen(extra_header_file_path.buf, "w");
+	fputs(header_strbuf.buf, extra_header_file);
+	fflush(extra_header_file);
+	fclose(extra_header_file);
+
+	strbuf_release(&header_strbuf);
+
 	if (is_rebase_i(opts) && !(flags & EDIT_MSG))
 		return run_command_silent_on_success(&cmd);
 	else
@@ -1522,6 +1543,7 @@ static int try_to_commit(struct repository *r,
 			 struct replay_opts *opts, unsigned int flags,
 			 struct object_id *oid)
 {
+	const char *exclude_gpgsig[] = { "gpgsig", "gpgsig-sha256", NULL };
 	struct object_id tree;
 	struct commit *current_head = NULL;
 	struct commit_list *parents = NULL;
@@ -1537,8 +1559,11 @@ static int try_to_commit(struct repository *r,
 	if (parse_head(r, &current_head))
 		return -1;
 
+	if (current_head) {
+		extra = read_commit_extra_headers(current_head, exclude_gpgsig);
+	}
+
 	if (flags & AMEND_MSG) {
-		const char *exclude_gpgsig[] = { "gpgsig", "gpgsig-sha256", NULL };
 		const char *out_enc = get_commit_output_encoding();
 		const char *message = repo_logmsg_reencode(r, current_head,
 							   NULL, out_enc);
@@ -1559,7 +1584,6 @@ static int try_to_commit(struct repository *r,
 			goto out;
 		}
 		parents = copy_commit_list(current_head->parents);
-		extra = read_commit_extra_headers(current_head, exclude_gpgsig);
 	} else if (current_head &&
 		   (!(flags & CREATE_ROOT_COMMIT) || (flags & AMEND_MSG))) {
 		commit_list_insert(current_head, &parents);
@@ -1741,9 +1765,11 @@ static int do_commit(struct repository *r,
 		if (is_rebase_i(opts) && oid)
 			if (write_rebase_head(oid))
 			    return -1;
-		return run_git_commit(msg_file, reflog_action, opts, flags);
+		return run_git_commit(msg_file, reflog_action, opts, NULL, flags);
 	}
 
+	fprintf(stderr, "do commit");
+
 	return res;
 }
 
@@ -2535,7 +2561,7 @@ static int do_pick_commit(struct repository *r,
 			 * got here.
 			 */
 			flags = EDIT_MSG | VERIFY_MSG | AMEND_MSG | ALLOW_EMPTY;
-			res = run_git_commit(NULL, reflog_action, opts, flags);
+			res = run_git_commit(NULL, reflog_action, opts, NULL, flags);
 			*check_todo = 1;
 		}
 	}
@@ -4071,6 +4097,7 @@ static int do_merge(struct repository *r,
 		    const char *arg, int arg_len,
 		    int flags, int *check_todo, struct replay_opts *opts)
 {
+	const char *exclude_gpgsig[] = { "gpgsig", "gpgsig-sha256", NULL };
 	struct replay_ctx *ctx = opts->ctx;
 	int run_commit_flags = 0;
 	struct strbuf ref_name = STRBUF_INIT;
@@ -4087,6 +4114,10 @@ static int do_merge(struct repository *r,
 	static struct lock_file lock;
 	const char *p;
 	const char *reflog_action = reflog_message(opts, "merge", NULL);
+	struct commit_extra_header *extra = NULL;
+	if (commit) {
+		read_commit_extra_headers(commit, exclude_gpgsig);
+	}
 
 	if (repo_hold_locked_index(r, &lock, LOCK_REPORT_ON_ERROR) < 0) {
 		ret = -1;
@@ -4359,13 +4390,13 @@ static int do_merge(struct repository *r,
 		 * command needs to be rescheduled).
 		 */
 		ret = !!run_git_commit(git_path_merge_msg(r), reflog_action,
-				       opts, run_commit_flags);
+				       opts, extra, run_commit_flags);
 
 	if (!ret && flags & TODO_EDIT_MERGE_MSG) {
 	fast_forward_edit:
 		*check_todo = 1;
 		run_commit_flags |= AMEND_MSG | EDIT_MSG | VERIFY_MSG;
-		ret = !!run_git_commit(NULL, reflog_action, opts,
+		ret = !!run_git_commit(NULL, reflog_action, opts, extra,
 				       run_commit_flags);
 	}
 
@@ -5196,8 +5227,11 @@ static int continue_single_pick(struct repository *r, struct replay_opts *opts)
 
 static int commit_staged_changes(struct repository *r,
 				 struct replay_opts *opts,
-				 struct todo_list *todo_list)
+				 struct todo_list *todo_list,
+				 struct commit *commit)
 {
+	const char *exclude_gpgsig[] = { "gpgsig", "gpgsig-sha256", NULL };
+	struct commit_extra_header *extra = NULL;
 	struct replay_ctx *ctx = opts->ctx;
 	unsigned int flags = ALLOW_EMPTY | EDIT_MSG;
 	unsigned int final_fixup = 0, is_clean;
@@ -5364,8 +5398,10 @@ static int commit_staged_changes(struct repository *r,
 		}
 	}
 
+	extra = read_commit_extra_headers(commit, exclude_gpgsig);
+
 	if (run_git_commit(final_fixup ? NULL : rebase_path_message(),
-			   reflog_action, opts, flags)) {
+			   reflog_action, opts, extra, flags)) {
 		ret = error(_("could not commit staged changes."));
 		goto out;
 	}
@@ -5417,7 +5453,14 @@ int sequencer_continue(struct repository *r, struct replay_opts *opts)
 			unlink(rebase_path_dropped());
 		}
 
-		if (commit_staged_changes(r, opts, &todo_list)) {
+		struct strbuf stopped_sha = STRBUF_INIT;
+		if (file_exists(rebase_path_stopped_sha())) {
+			read_oneliner(&stopped_sha, rebase_path_stopped_sha(), READ_ONELINER_WARN_MISSING);
+		}
+		struct object_id stopped_sha_oid;
+		get_oid_hex(stopped_sha.buf, &stopped_sha_oid);
+
+		if (commit_staged_changes(r, opts, &todo_list, lookup_commit_object(r, &stopped_sha_oid))) {
 			res = -1;
 			goto release_todo_list;
 		}
-- 
2.51.0

